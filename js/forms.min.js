/**
 *  @author: Isaac Vega Rodriguez          <isaacvega1996@gmail.com>
 */
function Form(e,t){"use strict"
if(!(this instanceof Form))return new Form(e,t)
var r=this
r._target=null,r._src=null,r._obj=null,r._events=["load","completed"],r._callbacs={},r._triggeredEvents=[],r._answeredCallbacs={},r.formObj={},r._pageRequirements={},r._lastArgumentOf={},r._componentList=["input","radio","checkbox","radioMatrix","checkboxMatrix","plainText"],r._defaultErrorMessage="This field is required. Please, fill it."
for(var n=0,a=r._events.length;n<a;n+=1)r._callbacs[r._events[n]]=[],r._answeredCallbacs[r._events[n]]=!1
if(arguments.length<2)throw new ReferenceError("Constructor must have at least 2 arguments")
if(!(arguments[0]instanceof HTMLDivElement))throw new TypeError("First element must be a <div> element")
if("string"!=typeof arguments[1])throw new TypeError("String expected as second argument")
r.setTarget(arguments[0])
var o="json",i=["json"]
arguments.length>2&&i.indexOf(arguments[2])>-1&&(o=arguments[2]),r.setSource(arguments[1],o)}Form._components={__from_items:function(e,t,r,n){var a=document
n.formObj[r.name]=null
for(var o=0,i=r.items.length;o<i;o+=1)!function(o,i){var s=!1
"radio"===t&&!0===/^%/.test(o)&&(!1===/^%%/.test(o)&&(s=!0),o=o.substr(1,o.length))
var l=a.createElement("li"),m=a.createElement("input"),c=a.createElement("span"),p=a.createElement("input")
p.setAttribute("type","text"),p.setAttribute("name",r.name),p.setAttribute("placeholder",""),p.setAttribute("form-type","form-extra-input"),m.setAttribute("type",t),m.setAttribute("name",r.name||""),m.setAttribute("itemNumber",i.toString())
var f=function(){"radio"===t?n.formObj[r.name]=o:"checkbox"===t&&(!0===m.checked?(n.formObj[r.name]=n.formObj[r.name]||[],n.formObj[r.name].push(o)):(n.formObj[r.name].splice(n.formObj[r.name].indexOf(o),1),0===n.formObj[r.name].length&&delete n.formObj[r.name]))}
if(m.addEventListener("click",f,!1),c.className="form-input-descriptor",c.innerHTML=Form.formatString(o),c.addEventListener("click",function(){"radio"===t?(m.checked=!0,f()):"checkbox"===t&&(m.checked=!m.checked,f())},!1),l.appendChild(m),l.appendChild(c),!0===s){var u=a.createElement("div"),d=a.createElement("div")
u.className="form-line-group",d.className="form-line-bottom",p.addEventListener("input",function(){m.checked=!0
var e=p.value
n.formObj[r.name]=""===e?null:e},!1),u.appendChild(p),u.appendChild(d),l.appendChild(u)}e.appendChild(l)}(r.items[o],o)},__from_matrix:function(e,t,r,n,a){!0===r.hasOwnProperty("answerBy")?-1===["rows","cols"].indexOf(r.answerBy)&&(r.answerBy="rows"):r.answerBy="rows"
var o=document
!function(){var e=n._pageRequirements[n._pages-1].indexOf(r.name)
n._pageRequirements[n._pages-1][e]={name:r.name,requirements:[]}
var t,a,o=n._pageRequirements[n._pages-1][e].requirements
if("cols"===r.answerBy)for(t=0,a=r.cols.length;t<a;t+=1)o.push(r.cols[t].name)
else for(t=0,a=r.rows.length;t<a;t+=1)o.push(r.rows[t].name)}(),n.formObj[r.name]={}
for(var i=n.formObj[r.name],s=function(e){var n=e.target,a=n.getAttribute("row"),o=n.getAttribute("col")
"radio"===t?"cols"===r.answerBy?i[o]=a:i[a]=o:"checkbox"===t&&("cols"===r.answerBy?(i[o]=i[o]||[],!0===n.checked?i[o].push(a):(i[o].splice(i[o].indexOf(a),1),0===i[o].length&&delete i[o])):(i[a]=i[a]||[],!0===n.checked?i[a].push(o):(i[a].splice(i[a].indexOf(o),1),0===i[a].length&&delete i[a])))},l=0,m=r.rows.length;l<m;l+=1){var c=o.createElement("tr"),p=o.createElement("th")
p.innerHTML=Form.formatString(r.rows[l].title||""),c.appendChild(p)
for(var f=0,u=r.cols.length;f<u;f+=1){var d=o.createElement("td"),h=o.createElement("input")
h.setAttribute("type",t),h.setAttribute("row",r.rows[l].name||""),h.setAttribute("col",r.cols[f].name||""),"rows"===r.answerBy?h.setAttribute("name",r.rows[l].name||""):h.setAttribute("name",r.cols[f].name||""),h.addEventListener("click",s,!1),d.appendChild(h),c.appendChild(d)}e.appendChild(c)}},__basic_component:function(e,t){t._pageRequirements[t._pages-1].push(e.name)
var r=document,n=r.createElement("div"),a=r.createElement("h3"),o=r.createElement("p")
return n.className="form-"+e.type+" form-container",a.className="form-title",o.className="form-subtitle",a.innerHTML=Form.formatString(e.title||""),o.innerHTML=Form.formatString(e.subtitle||""),n.appendChild(a),n.appendChild(o),"plainText"===e.type&&(e.name="_",e.optional=!0),n.setAttribute("form-name",e.name),!0===e.hasOwnProperty("validations")&&n.setAttribute("form-validations",JSON.stringify(e.validations)),!0===e.hasOwnProperty("optional")&&n.setAttribute("form-optional",Boolean(e.optional)),n},input:function(e,t){var r=document,n=this.__basic_component(e,t),a=r.createElement("div"),o=r.createElement("input"),i=r.createElement("div")
a.className="form-line-group",i.className="form-line-bottom",o.setAttribute("type","text"),o.setAttribute("name",e.name||""),o.setAttribute("size","30"),o.setAttribute("placeholder",e.placeholder||""),o.addEventListener("input",function(){var r=o.value.trim(),n=t.formObj
n[e.name]=""===r?null:r},!1),a.appendChild(o),a.appendChild(i)
var s=r.createElement("p")
return s.className="form-error",!0===e.hasOwnProperty("onError")?s.innerHTML=Form.formatString(e.onError):s.innerHTML=Form.formatString(t._defaultErrorMessage),n.appendChild(a),n.appendChild(s),n},radio:function(e,t){var r=document,n=this.__basic_component(e,t)
r.createElement("ul")
e.hasOwnProperty("items")&&this.__from_items(n,"radio",e,t)
var a=r.createElement("p")
return a.className="form-error",!0===e.hasOwnProperty("onError")?a.innerHTML=Form.formatString(e.onError):a.innerHTML=Form.formatString(t._defaultErrorMessage),n.appendChild(a),n},checkbox:function(e,t){var r=document,n=this.__basic_component(e,t)
r.createElement("ul")
e.hasOwnProperty("items")&&this.__from_items(n,"checkbox",e,t)
var a=r.createElement("p")
return a.className="form-error",!0===e.hasOwnProperty("onError")?a.innerHTML=Form.formatString(e.onError):a.innerHTML=Form.formatString(t._defaultErrorMessage),n.appendChild(a),n},radioMatrix:function(e,t){var r=document,n=this.__basic_component(e,t),a=r.createElement("table"),o=r.createElement("tr")
o.appendChild(r.createElement("th"))
for(var i=0,s=e.cols.length;i<s;i+=1){var l=r.createElement("th")
l.innerHTML=Form.formatString(e.cols[i].title||""),o.appendChild(l)}a.appendChild(o),this.__from_matrix(a,"radio",e,t,e.requirements||[])
var m=r.createElement("p")
return m.className="form-error",!0===e.hasOwnProperty("onError")?m.innerHTML=Form.formatString(e.onError):m.innerHTML=Form.formatString(t._defaultErrorMessage),n.appendChild(a),n.appendChild(m),n},checkboxMatrix:function(e,t){var r=document,n=this.__basic_component(e,t),a=r.createElement("table"),o=r.createElement("tr")
o.appendChild(r.createElement("th"))
for(var i=0,s=e.cols.length;i<s;i+=1){var l=r.createElement("th")
l.innerHTML=Form.formatString(e.cols[i].title||""),o.appendChild(l)}a.appendChild(o),this.__from_matrix(a,"checkbox",e,t,e.requirements||[])
var m=r.createElement("p")
return m.className="form-error",!0===e.hasOwnProperty("onError")?m.innerHTML=Form.formatString(e.onError):m.innerHTML=Form.formatString(t._defaultErrorMessage),n.appendChild(a),n.appendChild(m),n},plainText:function(e,t){var r=document,n=this.__basic_component(e,t),a=r.createElement("div")
return a.className="form-plain-text-body",a.innerHTML=Form.formatString(e.content),n.appendChild(a),n}},Form.VALIDATIONS={number:function(e,t){if(t=t||[],null===e||void 0===e)return!1
var r,n,a,o
if("string"==typeof e){if(a=parseFloat(e),!0===isNaN(a))return!1
for(;;){if(!((o=t.indexOf("integer"))>-1))break
if(t.splice(o,1),a!=~~a)return!1}for(var i=0,s=t.length;i<s;i+=1){if(t[i]=t[i].trim(),!0===/^>/.test(t[i])){if(!0===/^>=/.test(t[i])){if(r=parseFloat(t[i].substr(2,t[i].length)),a<r)return!1}else if(r=parseFloat(t[i].substr(1,t[i].length)),a<=r)return!1}else if(!0===/^</.test(t[i])){if(!0===/^<=/.test(t[i])){if(r=parseFloat(t[i].substr(2,t[i].length)),a>r)return!1}else if(r=parseFloat(t[i].substr(1,t[i].length)),a>=r)return!1}else if(!0===/^==/.test(t[i])){if((r=parseFloat(t[i].substr(2,t[i].length)))!=a)return!1}else if(!0===/^!=/.test(t[i])&&(r=parseFloat(t[i].substr(2,t[i].length)))===a)return!1
if(!0===/:/.test(t[i]))if(!0===/^!/.test(t[i])){var l=t[i].substr(1,t[i].length).split(":")
if(2===l.length&&(r=parseFloat(l[0]),n=parseFloat(l[1]),r<=a&&a<=n))return!1}else{var l=t[i].split(":")
if(2===l.length&&(r=parseFloat(l[0]),n=parseFloat(l[1]),r>a||a>n))return!1}}return!0}return"number"==typeof e},text:function(e,t){t=t||[]
for(var r,n=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,a=/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \?=.-]*)*\/?$/,o=0,i=t.length;o<i;o+=1){if(t[o]=t[o].trim(),!0===/^(not)?contains/.test(t[o])&&(r=t[o].split(":"),r.shift(),""!==(r=r.join(":"))))return!0===/^not/.test(t[o])?-1===e.indexOf(r):e.indexOf(r)>-1
if("email"===t[o]&&!1===n.test(e))return!1
if("url"===t[o]&&!1===a.test(e))return!1}return!0},regexp:function(e,t){for(var r,n=0,a=t.length;n<a;n+=1)if(r=RegExp(t[n]),!1===r.test(e))return!1
return!0},length:function(e,t){return t=t||{},!(!0===t.hasOwnProperty("min")&&(t.min=~~t.min,t.min>=0&&e.length<t.min))&&!(!0===t.hasOwnProperty("max")&&(t.max=~~t.max,t.max>=0&&e.length>t.max))}},Form.formatString=function(e){return"string"==typeof e?e.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""},Form.prototype.validate=function(e,t){return!0!==Form.VALIDATIONS.hasOwnProperty(e.type)||Form.VALIDATIONS[e.type].call(this,t,e.list||[])},Form.prototype.addValidation=function(e,t){return"string"==typeof e&&""!==(e=e.trim())&&"function"==typeof t&&(Form.VALIDATIONS[e]=t,!0)},Form.prototype.on=function(e,t){var r=this
"string"==typeof e&&"function"==typeof t&&r._events.indexOf(e)>-1&&(r._callbacs[e].push(t),r._triggeredEvents.indexOf(e)>-1&&t.apply(r,r._lastArgumentOf[e]))},Form.prototype.triggerEvent=function(e){var t,r,n=this,a=Array.from(arguments).slice(1,arguments.length)
if(n._events.indexOf(e)>-1)if(-1===n._triggeredEvents.indexOf(e))for(n._triggeredEvents.push(e),n._lastArgumentOf[e]=a,t=0,r=n._callbacs[e].length;t<r;t+=1)n._callbacs[e][t].apply(n,a)
else for(0===a.length&&(a=n._lastArgumentOf[e]),a!=n._lastArgumentOf[e]&&(n._lastArgumentOf[e]=a),t=0,r=n._callbacs[e].length;t<r;t+=1)n._callbacs[e][t].apply(n,a)},Form.prototype.setTarget=function(e){if(!(e instanceof HTMLDivElement))throw new TypeError("First element must be a <div> element")
this._target=e},Form.prototype.setSource=function(e,t){var r=this,n=new XMLHttpRequest
n.open("GET",e,!0),n.addEventListener("load",function(e){if(4===e.target.readyState&&e.target.status<400){var n
return"json"===t&&(n=JSON.parse(e.target.responseText)),r._obj=n,r.triggerEvent("load",n),void r.compile()}throw new Error("Error while loading the data")},!1),n.send(null)},Form.prototype.createComponent=function(e,t){var r=document.createElement("div")
return r.className="form-"+e,!0===Form._components.hasOwnProperty(e)?Form._components[e](t,this):r},Form.prototype.nextPage=function(){this.goToPage(this._currentPage+1)},Form.prototype.prevPage=function(){this.goToPage(this._currentPage-1)},Form.prototype.goToPage=function(e){if((e=~~e)<0)throw new TypeError("Expected a non-negative number as page index.")
if(null==this._target)throw new ReferenceError("Target element not found")
var t=this._target.querySelectorAll(".form-page"),r=this._target.querySelector(".form-next-page"),n=this._target.querySelector(".form-prev-page"),a=this._target.querySelector(".form-submit")
if(!t)throw new ReferenceError("No page found")
if(!(t.length>e))throw new ReferenceError("Page #"+e+" not found")
this._currentPage=e,this._currentPage+1<t.length?(r.classList.remove("form-hidden"),a.classList.add("form-hidden")):(r.classList.add("form-hidden"),a.classList.remove("form-hidden")),this._currentPage-1>=0?n.classList.remove("form-hidden"):n.classList.add("form-hidden")
for(var o=0,i=t.length;o<i;o+=1)o!=e?t[o].classList.add("form-hidden"):t[o].classList.remove("form-hidden")},Form.prototype.pageComplete=function(){var e=this,t=e._currentPage,r=document,n=function(t,a,o){for(var i,s,l=!0,m=0,c=t.length;m<c;m+=1){if(i=!0,"string"==typeof t[m]){if(""===(s=t[m]))continue
!1===a.hasOwnProperty(t[m])?i=!1:!1===Boolean(a[t[m]])&&(i=!1)}else{if(""===(s=t[m].name))continue
i=n(t[m].requirements,a[t[m].name],o+1)}if(0===o&&"string"==typeof t[m]){var p=r.querySelector('[form-name="'+s+'"]')
if(null!=p){var f=p.getAttribute("form-validations"),u=!!p.getAttribute("form-optional")
if(null!=f)if(f=JSON.parse(f),!1===i)i=u
else for(var d=0,h=f.length;d<h&&!0===i;d+=1)!1===e.validate(f[d],a[t[m]])&&(i=!1)
else"_"!==s&&!0!==u||(i=!0)}}!1===i&&0===o?r.querySelector('[form-name="'+s+'"]').classList.add("form-incomplete"):!0===i&&0===o&&r.querySelector('[form-name="'+s+'"]').classList.remove("form-incomplete"),l=l&&i}return l}
return n(e._pageRequirements[t],e.formObj,0)},Form.prototype.compile=function(){if(null==this._target)throw new ReferenceError("Target element not found")
var e=this,t=e._target,r=0,n=document
t.innerHTML=""
var a=n.createElement("ul")
a.className="form-pagelist"
!function t(a,o){for(var i=Object.keys(o),s=a,l=0,m=i.length;l<m;l+=1)if("type"===i[l])if("page"===o.type){e._pageRequirements[r]=[],r+=1,e._pages=r
var c=n.createElement("li"),p=n.createElement("h2"),f=n.createElement("p")
c.className="form-page",p.className="form-page-header form-title",f.className="form-page-subtitle form-subtitle",p.innerHTML=Form.formatString(o.title),f.innerHTML=Form.formatString(o.subtitle),c.appendChild(p),c.appendChild(f),s.appendChild(c),s=c}else e._componentList.indexOf(o.type)>-1&&s.appendChild(e.createComponent(o.type,o))
else if("items"===i[l])for(var u=0,d=o.items.length;u<d;u+=1)t(s,o.items[u])}(a,e._obj),t.appendChild(a)
var o=n.createElement("div"),i=n.createElement("button"),s=n.createElement("button"),l=n.createElement("button")
i.innerHTML="Previous",s.innerHTML="Next",l.innerHTML="Submit",o.className="form-btn-container",s.className="form-next-page",i.className="form-prev-page",l.className="form-submit",i.addEventListener("click",function(){e.prevPage()},!1),s.addEventListener("click",function(){!0===e.pageComplete()&&e.nextPage()},!1),l.addEventListener("click",function(){!0===e.pageComplete()&&e.triggerEvent("completed",e.formObj)},!1),o.appendChild(i),o.appendChild(s),o.appendChild(l),o.appendChild(l),a.appendChild(o),e.goToPage(0)}
